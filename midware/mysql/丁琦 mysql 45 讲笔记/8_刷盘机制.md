## mysql 的刷盘机制

之前提过, mysql 的日志系统有两个重要的组成部分 `redo log` 和 `binlog`

`redo log` 是先写入内存缓冲区,在找合适的实际将内存缓冲区的内容写入磁盘

**当内存页跟磁盘页保存的内容不一致的时候,这个内存页被称为 `脏页`. 将脏页写入磁盘后,此时内存页的数据和磁盘页的数据一致,称为 `干净页`**

刷脏页的过程,可能会导致 mysql 运行时的 **抖动**

### 什么时候触发刷脏页

1. 如果 `redo log` 写满了,此时会阻塞后面的写请求,必须由 `redo log` 刷脏页推进 `checkpoint` 位置腾出空间来
2. 当 mysql 的内存不足,即 `buffer pool` 空间不够,需要加载新的页到内存时,会将 `buffer pool` 里面的脏页刷到磁盘里腾出空间来
3. 当 mysql 认为系统处于空闲时,会定时刷新 `buffer pool` 里面的脏页到磁盘当中
4. mysql 停机前,会把 `buffer pool` 里面的所有脏页全部刷入磁盘

对于第一种情况,`redo log` 写满了需要刷新脏页,这种情况要尽可能避免,因为此时会阻塞后面的所有更新请求

对于第二种情况,`buffer pool` 内存不够用了,需要刷新脏页,这是常态 **(因为内存总是稀缺资源)**,此时 `buffer pool` 里面有三种状态的内存页

1. 还没有使用过的页
2. 使用过,并且是干净页
3. 使用过,并且是脏页

对于 InnoDB 来说,尽可能使用内存加快处理速度,所以第一种未使用的页几乎很少

当需要访问的页不在 `buffer pool` 当中时,就必须要磁盘里面加载到内存; 如果淘汰的是干净页,就直接释放; 如果淘汰的是脏页,就必须刷盘后释放

出现如下情况,会导致刷盘影响性能:

1. 一个查询需要淘汰的脏页太多,会导致这个查询的处理时间明显变长
2. 日志写满

### InnoDB 刷脏页的策略

InnoDB 刷脏页有个很经典的 **连坐** 策略,也就是说当有一个脏页需要刷盘时,如果它旁边也是脏页那就会连带着这个 **邻居** 一起刷掉,而且对于 **邻居** 的邻居也会继续蔓延下去

一般情况下,这个需要关闭这个策略,因为对于查询来说,往往需要更快的执行完刷盘操作,减少查询的响应时间